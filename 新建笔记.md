# [可能是全网最简单]R9000P2021H-3070LATOP-双显卡kvm直通教程

## 本教程理论上AMD平台笔记本通用

处理器: AMD 锐龙 5800H 8核
显卡:  GeForce RTX 3070 Latop 8G MAX-Q
内存: 64GB 2666Mhz 32G双通道
系统环境：ubuntu 22.04 lst
桌面环境: KDE Plasma 5.2

<br/>

操作之前进入BIOS

将显卡模式从直通模式设置为混合模式，否则就得使用单显卡直通方案（宿主系统黑屏）

打开AMD-VT虚拟化技术

关闭安全启动！！！

一定要关闭安全启动！！

<br/>

## 开启IOMMU

sudo vim /etc/defaule/grub 

查找

```
GRUB_CMDLINE_LINUX_DEFAULT=""
```

修改为：

```
GRUB_CMDLINE_LINUX_DEFAULT="amd_iommu=on iommu=pt kvm_amd.npt=1 kvm_amd.avic=1 " 
```

按下esc

shift+：wq！保存并退出

<br/>

输入指令sudo update-grub更新引导程序

重启电脑

sudo reboot

## 检查IOMMU组:

```
sudo dmesg | grep iommu
```

<br/>

![Screenshot_20220712_154418.png](4d188287ec7514cefcf70c8a102736d7.png)

如图所示代表IOMMU已经开启

<br/>

在终端输入以下脚本查看显卡所在IOMMU组

```
shopt -s nullglob
for g in `find /sys/kernel/iommu_groups/* -maxdepth 0 -type d | sort -V`; do
    echo "IOMMU Group ${g##*/}:"
    for d in $g/devices/*; do
        echo -e "\t$(lspci -nns ${d##*/})"
    done;
done;

```

![Screenshot_20220712_155320.png](077e53985bafe47e6e8dd00c77b51196.png)

```
IOMMU Group 10:
        01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GA104M [GeForce RTX 3070 Mobile / Max-Q] [10de:24dd] (rev a1)
        01:00.1 Audio device [0403]: NVIDIA Corporation GA104 High Definition Audio Controller [10de:228b] (rev a1)

```

记下这两个地址，一会要用到

<br/>

再次sudo vim  /etc/defaule/grub 

按i进入编辑模式，方向键移动将

```
GRUB_CMDLINE_LINUX_DEFAULT="amd_iommu=on iommu=pt kvm_amd.npt=1 kvm_amd.avic=1 " 
```

修改为

```
GRUB_CMDLINE_LINUX_DEFAULT="amd_iommu=on iommu=pt kvm_amd.npt=1 kvm_amd.avic=1 vfio-pci.ids=10de:24dd,10de:228b" 

```

esc

shift+：wq！保存并退出

输入指令sudo update-grub更新引导程序

<br/>

<br/>

## 屏蔽显卡驱动：

sudo vim /etc/modprobe.d/blacklist.conf

按i进入编辑模式，方向键移动到文件末端插入代码

```
blacklist nouveau
```

esc

shift+：wq！保存并退出

再次重启电脑
sudo reboot

<br/>

查看显卡信息是否为VFIO接管：

```
lspci -vnn | grep VGA -A 12
```

如果命运的齿轮没有出错，如下图所示代表成功接管

此时可继续操作

![Screenshot_20220712_155223.png](d13df33d4fabba2e58a5d5f0af2b9371.png)

<br/>

更新一下系统：

```
sudo apt update -y
```

<br/>

开始安装软件包：

```
sudo apt-get install ovmf  qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virtinst virt-manager -y
```

（tips：如果你安装速度很慢建议先换一个镜像源哦）

安装速度因人而异，别急

![Screenshot_20220712_184043.png](8320ff11be16f90b0737a9db67a363ca.png)

<br/>

## 配置QEMU权限

编辑libvirt.conf

```
sudo vim /etc/libvirt/libvirtd.conf
```

找到这两行，把前面的#删掉：

```
unix_sock_group = "libvirt"
unix_sock_rw_perms = "0770"
```

编辑qemu.conf

```
sudo vim /etc/libvirt/qemu.conf
```

 #user = "root" 改成 user = "这里是你的用户名",
#group = "root" 改成 group = "libvirt"

（同样去除#号注释）

把自己添加到libvirt组里面：

```
sudo usermod -a -G libvirt 你的用户名
```

之后，重启电脑或者使用以下命令重启libvirt和qemu

```
sudo systemctl restart libvirtd.service
sudo systemctl restart virtlogd.socket 
sudo systemctl restart qemu-kvm.service
```

<br/>

## 修改显卡VBIOS

有些电脑如果不修改显卡VBiOS虚拟机会遇到死机，黑屏，闪屏，代码31等奇奇怪怪的问题。

（tips：有些电脑也可能不需要，这一步因人而异。
建议先直接把显卡VBIOS通入虚拟机测一下，出现问题再打补丁）

所以保险起见我们需要给显卡VBiOS打一个补丁。

<br/>

首先你要想办法得到你电脑显卡的VBIOS

可以去Windows下用GPU-Z提取

可以去TechPowerUp寻找你这个显卡厂商的VBIOS

（https://www.techpowerup.com/vgabios/）

![Screenshot_20220712_222250.png](678098e7684f8381671dc6176d765279.png)

总之我不管你用什么办法，你要得到你显卡的VBIOS文件

![Screenshot_20220712_222355.png](9a111be2b77c7ca6089daa175c936314.png)

得到ROM文件后，此时打开终端输入：

```
sudo apt install bless -y
```

<br/>

![Screenshot_20220712_222815.png](b281a7059eeb4f96de326f325834cb8d.png)

<br/>

启动bless，Ctrl+O打开你刚才的VBiOS文件

CTRL+F 搜索 VIDEO 类型选择Text

![Screenshot_20220712_223243.png](81b8ff59504296aca470f8fc1e35b725.png)

选中第一个大写“U”，将前面的内容全部删除

改成如下图所示的样子，将文件另存为，放到一个你能找得到的地方。

![Screenshot_20220712_223528.png](95ec6e23a53414638dc028913a32c2a3.png)

<br/>

<br/>

## **准备虚拟电池补丁**

下载本仓库根目录下的sstd1.dat文件放在你能找到的地方留着备用

如果没有虚拟电池补丁装驱动时容易卡代码43！！

<br/>

## 准备Windows ISO镜像

我不多说

Windows 10 Enterprise LTSC 2021 (x64) - DVD (Chinese-Simplified)
文件：SW_DVD9_WIN_ENT_LTSC_2021_64BIT_ChnSimp_MLF_X22-84402.ISO
大小：4.7GB

magnet:?xt=urn:btih:366ADAA52FB3639B17D73718DD5F9E3EE9477B40&dn=SW_DVD9_WIN_ENT_LTSC_2021_64BIT_ChnSimp_MLF_X22-84402.ISO&xl=5044211712

<br/>

https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise

懂得都懂

什么？你不会下载?

不会吧不会吧。都折腾linux了，不会连这点能力都没有吧？？？

<br/>

## 准备Virtio ISO 驱动

<br/>

https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.217-2/

下载最近版本即可

![Screenshot_20220712_231906.png](618bf464bae98be295dfdd519bab4acd.png)

## 重头戏-开始安装Windows

 一切准备就绪后启动虚拟系统管理器

![Screenshot_20220712_184133.png](25e6f8f1e75f346d1824a9b843cf0550.png)

界面如图

![Screenshot_20220712_232200.png](f9d5b304b56fc645505132b876113708.png)

<br/>

以此点击：

编辑->preferences 启用一下XML编辑

随后关闭

![Screenshot_20220712_232339.png](83c62e1f1facd4fb4a554f1341a0c671.png)

文件-新建虚拟机，选择你刚才下载的Windows iso文件

![Screenshot_20220712_232629.png](468a2472445e8ad50a3e4295acd2f3ba.png)

调整一下内存

![Screenshot_20220712_232716.png](6316ea0cfb88f8dbb0b7875fe505aa3c.png)

创建一个虚拟磁盘，格式qcow2就好

![Screenshot_20220712_232825.png](df12c075684d015ec9b3ba89f02c0c54.png)

<br/>

勾选“在安装前自定义配置”

![Screenshot_20220712_232921.png](1abe6c80f9a1872570e95e02cc67bd43.png)

芯片组选择Q35 ，固件如图所示

![Screenshot_20220712_233017.png](b9d96fd59de76ef405a2b6234dc69c2c.png)

CPU核心建议给宿主机留下两个，不然你玩游戏可能会掉帧

![Screenshot_20220712_233159.png](c958f5bb07455c9689d89fc6c305494c.png)

引导选项勾上SATA1将他设置为第一个

![Screenshot_20220712_233355.png](ff5eb962873059613d8799fb5eb986b2.png)

网卡和硬盘都要选择virtio，性能好

![Screenshot_20220712_233511.png](f1a739463b76a77d6e685f132dd8d484.png)

![Screenshot_20220712_233421.png](9932cf11dfd1ae24653c963b4b27226e.png)

添加一个新虚拟设备，将你的virtio iso格式驱动文件载入进去

![Screenshot_20220712_233602.png](0224a4a395cff4c22512c9b67a21e157.png)

随后点击开始安装，点击虚拟机屏幕，按任意键即可进入安装程序。

![Screenshot_20220712_233931.png](3b0ca4de7a888174e599eafaa4908516.png)

选择自定义

![Screenshot_20220712_233931.png](3b0ca4de7a888174e599eafaa4908516.png)

加载驱动程序

![Screenshot_20220712_234131.png](83968e5d7f5d7427704e1ce369ffb532.png)

加载磁盘驱动

![Screenshot_20220712_234213.png](822d70127506c663534077ae651ea6c1.png)

随后再点击游览，加载网卡驱动

![Screenshot_20220712_234343.png](c6e7f8bfb5c382e0787b65a06aff64f0.png)

<br/>

给虚拟硬盘分下区

![Screenshot_20220712_234448.png](7c50b3fa7912c3faf2bc51b3004f324b.png)

<br/>

喝杯茶休息一下吧

![Screenshot_20220712_234514.png](bcd2f576098f3e48cb90de06f42dfbe8.png)

接下来就是一路下一步下一步点点点进入桌面就好了

庆祝吧，此时你已经成功一半了！

![Screenshot_20220712_235056.png](b4acc2508f3d6407dd3be8797200a74b.png)

<br/>

<br/>

## 尾声（终于要结束了呢）

<br/>

将虚拟机关机，进入收尾阶段

![Screenshot_20220712_235202.png](e66e5241e6d91905db0d6384a2a043c7.png)

<br/>

<br/>

<br/>

添加PCI主机设备，将你的显卡核心和你显卡自带的音频控制器一起添加进去

![截图](1c51c6c0151b9a60c42676c440a1c801.png)

<br/>

![Screenshot_20220712_235553.png](41d5d37923a97a7d5755f1a9064eb07e.png)

<br/>

## 注意！！！

### 虽然NVDIA之前宣称2021年4月以后的英伟达显卡驱动已经不需要绕过虚拟化检测了。

### 以后在虚拟机平台安装显卡驱动不会有代码43错误。

### 但移动端平台至今依然有虚拟化检测，因此我们不能直接将显卡通入虚拟机

# So Nvdia F**k You

![Screenshot_20220713_012146.png](944b3de1689f9218884dd49319be5c00.png)

<br/>

将显卡设置为ramfb

![Screenshot_20220712_235758.png](48c7513a62c68b7f87192aa6c87ddce1.png)

将网卡bus改为0x12

![Screenshot_20220712_235900.png](5117430d789080588b9dd48e9d955ee8.png)

将显卡核心和显卡音频控制器配置文件改为如下图所示：

![Screenshot_20220713_000416.png](63ac93e84d79996e4c36a979fba15c56.png)

![Screenshot_20220713_000502.png](a8a2194cf8d562513a89e019b7874f14.png)

<br/>

点开概括，将第一行

```xml
<domain type="kvm">
```

修改为

```xml
<domain xmlns:qemu="http://libvirt.org/schemas/domain/qemu/1.0" type="kvm">
```

在   </hyperv>前面加入vendor_id

```xml
  <vendor_id state="on" value="fuckyounvdia"/>
```

在   </hyperv>后面添加反虚拟化检测

```xml
  <kvm>
      <hidden state="on"/>
  </kvm>
```

  在 </devices> 后面添加虚拟电池补丁

```xml
  <qemu:commandline>
    <qemu:arg value="-acpitable"/>
    <qemu:arg value="file=/usr/share/OVMF/ssdt1.dat"/>  <!--这里的路径自己改一下-->
  </qemu:commandline>
```

<br/>

深吸一口气，双手合并。

 开机！

进入系统可以看到虚拟电池已经生效！

![Screenshot_20220713_020943.png](647480e825a4d54b231cab1c755210fa.png)

此时去nvdia官网下载最新版显卡驱动安装即可

![Screenshot_20220713_022059.png](390a805fddc692b587c61c8ea313f78c.png)

<br/>

一切顺利的话，此时已经可以在任务管理器看到你的显卡了！

![Screenshot_20220713_021722.png](fa4e6e8be6c2f3ac1142e1f6752e9dd6.png)

愉快玩耍吧！

emjor！

## 尾声-虚拟机完善篇（施工中）：

施工中，未完待续！
